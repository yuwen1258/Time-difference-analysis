<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>ArcGIS JS API + Custom Flask API</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }
        #controls {
            padding: 10px;
            background-color: white;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>

    <script src="https://js.arcgis.com/4.33/"></script>

    <script type="module">
        const [Map, MapView, GeoJSONLayer, Legend, esriConfig, Expand, Graphic, GraphicsLayer] = await $arcgis.import([
            "@arcgis/core/Map.js",
            "@arcgis/core/views/MapView.js",
            "@arcgis/core/layers/GeoJSONLayer.js",
            "@arcgis/core/widgets/Legend.js",
            "@arcgis/core/config.js",
            "@arcgis/core/widgets/Expand.js",
            "@arcgis/core/Graphic.js",
            "@arcgis/core/layers/GraphicsLayer.js"
        ]);
        esriConfig.portalUrl = "https://igisportal.geomatics.ncku.edu.tw/portal/";

        // 圖層群組
        const thematicLayers = {
            "人口統計": {
                "總人口數": {
                    field: "p_cnt", // 這個指標對應的計算欄位
                    location_id: "village",
                    layers: [
                        { name: "110年12月 綠島村里總人口數", year: 110, id: "974ade8073ac4457bf6ae42f5b8ec0a7" },
                        { name: "111年12月 綠島村里總人口數", year: 111, id: "e9f3730a70764e5d8dd403c75fa9c096" },
                        { name: "112年12月 綠島村里總人口數", year: 112, id: "ea29b005256d459ab331afab22f388cb" },
                        { name: "113年12月 綠島村里總人口數", year: 113, id: "f8c0e16368ac4f4285ab83c1fb6da83d" }
                    ]
                },
                "總戶數": {
                    field: "h_cnt", // 不同的指標，不同的欄位
                    location_id: "village",
                    layers: [
                        { name: "110年12月 綠島村里總戶數", year: 110, id: "974ade8073ac4457bf6ae42f5b8ec0a7" },
                        { name: "111年12月 綠島村里總戶數", year: 111, id: "e9f3730a70764e5d8dd403c75fa9c096" },
                        { name: "112年12月 綠島村里總戶數", year: 112, id: "ea29b005256d459ab331afab22f388cb" },
                        { name: "113年12月 綠島村里總戶數", year: 113, id: "f8c0e16368ac4f4285ab83c1fb6da83d" }
                    ]
                },
                "男性人口數": {
                    field: "m_cnt", // 不同的指標，不同的欄位
                    location_id: "village",
                    layers: [
                        { name: "110年12月 綠島村里男性人口數", year: 110, id: "974ade8073ac4457bf6ae42f5b8ec0a7" },
                        { name: "111年12月 綠島村里男性人口數", year: 111, id: "e9f3730a70764e5d8dd403c75fa9c096" },
                        { name: "112年12月 綠島村里男性人口數", year: 112, id: "ea29b005256d459ab331afab22f388cb" },
                        { name: "113年12月 綠島村里男性人口數", year: 113, id: "f8c0e16368ac4f4285ab83c1fb6da83d" }
                    ]
                },
                "女性人口數": {
                    field: "f_cnt", // 不同的指標，不同的欄位
                    location_id: "village",
                    layers: [
                        { name: "110年12月 綠島村里女性人口數", year: 110, id: "974ade8073ac4457bf6ae42f5b8ec0a7" },
                        { name: "111年12月 綠島村里女性人口數", year: 111, id: "e9f3730a70764e5d8dd403c75fa9c096" },
                        { name: "112年12月 綠島村里女性人口數", year: 112, id: "ea29b005256d459ab331afab22f388cb" },
                        { name: "113年12月 綠島村里女性人口數", year: 113, id: "f8c0e16368ac4f4285ab83c1fb6da83d" }
                    ]
                }
            },
            "醫療院所": {
                "醫院數量": {
                    field: "h_cnt",
                    location_id: "codebase",
                    layers: [
                        { name: "112年12月綠島鄉統計區醫療院所統計_最小統計區", year: 112, id: "325d138727be424a8842c2e082dd8770" }
                    ]
                }
            }
        };
        
        // 4. 建立地圖和視圖
        const map = new Map({
            basemap: "dark-gray" // 使用 Esri 的地形底圖
        });

        const view = new MapView({
            container: "viewDiv",
            map: map,
            center: [121.48993978911774, 22.655928615598178], // 中心點設為綠島
            zoom: 13
        });

        // 1. 取得所有選單的 DOM 元素
        const themeSelector = document.getElementById("themeSelector");
        const subThemeSelector = document.getElementById("subThemeSelector"); // 新增
        const layerSelector1 = document.getElementById("layerSelector1");
        const layerSelector2 = document.getElementById("layerSelector2");
        const controlsContainer = document.getElementById("controls");

        // 2. 函式：填滿「主題」選單 (不變)
        function populateThemeSelector() {
            const themes = Object.keys(thematicLayers);
            themes.forEach(theme => {
                const option = new Option(theme, theme);
                themeSelector.appendChild(option);
            });
        }

        // 3. 新函式：根據選擇的「主題」，填滿「指標」選單
        function updateSubThemeSelector(selectedTheme) {
            // 清空指標和圖層選單
            subThemeSelector.innerHTML = '<option value="">-- 請選擇 --</option>';
            layerSelector1.innerHTML = '<option value="">-- 請先選擇指標 --</option>';
            layerSelector2.innerHTML = '<option value="">-- 請先選擇指標 --</option>';
            subThemeSelector.disabled = true;
            layerSelector1.disabled = true;
            layerSelector2.disabled = true;

            if (!selectedTheme) return;

            // 取得該主題下的所有指標
            const subThemes = Object.keys(thematicLayers[selectedTheme]);
            subThemes.forEach(subTheme => {
                const option = new Option(subTheme, subTheme);
                subThemeSelector.appendChild(option);
            });
            subThemeSelector.disabled = false;
        }

        // 4. 修改函式：根據選擇的「主題」和「指標」，填滿「圖層」選單
        function updateLayerSelectors(selectedTheme, selectedSubTheme) {
            layerSelector1.innerHTML = "";
            layerSelector2.innerHTML = "";

            if (!selectedTheme || !selectedSubTheme) {
                const defaultOption = new Option("-- 請先選擇指標 --", "");
                layerSelector1.appendChild(defaultOption);
                layerSelector2.appendChild(defaultOption.cloneNode(true));
                layerSelector1.disabled = true;
                layerSelector2.disabled = true;
                return;
            }

            // 根據主題和指標，取得對應的圖層陣列
            const layers = thematicLayers[selectedTheme][selectedSubTheme].layers;
            
            layers.forEach(layer => {
                // 將 layer 物件 {name, year, id} 轉成 JSON 字串存入 value
                const optionValue = JSON.stringify(layer);
                const option = new Option(layer.name, optionValue);
                layerSelector1.appendChild(option);
                layerSelector2.appendChild(option.cloneNode(true));
            });

            layerSelector1.disabled = false;
            layerSelector2.disabled = false;
            syncLayerSelectors(layerSelector1, layerSelector2); // 保持禁用相同選項的功能
        }


        // 5. 設定事件監聽器
        themeSelector.addEventListener("change", (event) => {
            updateSubThemeSelector(event.target.value);
        });

        subThemeSelector.addEventListener("change", () => {
            const selectedTheme = themeSelector.value;
            const selectedSubTheme = subThemeSelector.value;
            updateLayerSelectors(selectedTheme, selectedSubTheme);
        });

        // syncLayerSelectors 和 layerSelector 的事件監聽器保持不變
        function syncLayerSelectors(changedSelector, targetSelector) {
            const selectedValue = changedSelector.value;
            const options = targetSelector.options;

            // 遍歷目標選單的所有選項
            for (let i = 0; i < options.length; i++) {
                // 如果選項的值和被選中的值相同，就禁用它
                if (options[i].value === selectedValue) {
                    options[i].disabled = true;
                } else {
                    // 否則就確保它是啟用的（當使用者來回切換選擇時）
                    options[i].disabled = false;
                }
            }
        }
        layerSelector1.addEventListener("change", () => { syncLayerSelectors(layerSelector1, layerSelector2); });
        layerSelector2.addEventListener("change", () => { syncLayerSelectors(layerSelector2, layerSelector1); });

        // 頁面載入後，先填滿主題選單
        populateThemeSelector();

        // 5. 監聽按鈕點擊事件
        document.getElementById("runAnalysisBtn").addEventListener("click", () => {

            // 1. 獲取所有選單的當前值
            const selectedTheme = themeSelector.value;
            const selectedSubTheme = subThemeSelector.value;
            const selectedLayer1String = layerSelector1.value;
            const selectedLayer2String = layerSelector2.value;

            // 2. 基礎驗證
            if (!selectedTheme || !selectedSubTheme || !selectedLayer1String || !selectedLayer2String) {
                alert("請選擇分析圖層！");
                return;
            }

            if (selectedLayer1String && selectedLayer2String && selectedLayer1String === selectedLayer2String) {
                alert("請選擇兩個不同的圖層進行比較！");
                return; // 停止後續所有程式碼的執行
            }

            if (!selectedLayer1String || !selectedLayer2String) {
                alert("請選擇兩個要分析的圖層！");
                return;
            }

            // 3. 從資料結構中找到對應的計算欄位
            const analysisField = thematicLayers[selectedTheme][selectedSubTheme].field;
            const LIDField = thematicLayers[selectedTheme][selectedSubTheme].location_id;

            // 4. 解析圖層資訊，並組合出要發送到後端的物件
            const layer1Data = JSON.parse(selectedLayer1String);
            const layer2Data = JSON.parse(selectedLayer2String);

            const payloadLayer1 = {
                id: layer1Data.id,
                location_id: LIDField,
                year: layer1Data.year,
                field: analysisField // 使用從指標層級獲取的欄位
            };
            const payloadLayer2 = {
                id: layer2Data.id,
                location_id: LIDField,
                year: layer2Data.year,
                field: analysisField // 兩個圖層使用同一個指標欄位
            };
            
            // 清除上一次的圖層
            const oldLayer = map.findLayerById("dynamicDataLayer");
            if(oldLayer){
                map.remove(oldLayer);
            }

            alert("正在進行運算，請稍等...");

            // 6. Fetch 邏輯
            fetch('https://time-difference-analysis.onrender.com/api/time-difference', {
                method: 'POST',
                // --- 新增 body 來傳遞參數 ---
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    itemId1: payloadLayer1,
                    itemId2: payloadLayer2
                })
            })
            .then(response => {
            if (!response.ok) {
                // .text() 會讀取錯誤訊息的內容
                return response.text().then(text => { throw new Error(text) });
            }
            return response.json();
            }).then(records => {
                //alert("成功取得資料，正在建立分析結果圖層！");

                // 8. 建立渲染器 (Renderer)，根據 VALUE_DIFF 欄位來分級設色
                const increased = {
                    type: "simple-fill",
                    color: "#e63946",
                    outline: { color: "white", width: 0.5 }
                }

                const same = {
                    type: "simple-fill",
                    color: "#fefae0",
                    outline: { color: "white", width: 0.5 }
                }

                const decreased = {
                    type: "simple-fill",
                    color: "#669bbc",
                    outline: { color: "white", width: 0.5 }
                }

                // 9. 建立彈出視窗 (Popup) 模板
                const popupTemplate = {
                    title: "{LID}", // {行政區欄位名稱}
                    fieldInfos: [
                        {
                            fieldName: "VALUE_DIFF",
                            visible: false,
                            label: "數值差異"},
                        {
                            fieldName: "YEAR_OLD",
                            label: "較舊時間"},
                        {
                            fieldName: "VALUE_OLD",
                            label: "較舊時間數值"},
                        {
                            fieldName: "YEAR_NEW",
                            label: "較新時間"},
                        {
                            fieldName: "VALUE_NEW",
                            label: "較新時間數值"},
                    ],
                    content: [
                        {type: "text",
                            text: "<b>數值變化為 {VALUE_DIFF} </b>"
                        },
                        {type: "fields"}
                    ]
                };

                // 遍歷從後端收到的每一筆紀錄
                const graphics = records.map(record => {

                    const renderer = (record.VALUE_DIFF > 0)
                        ? increased
                        : (record.VALUE_DIFF < 0)
                            ? decreased
                            : same;
                    
                    // 3. 建立 Graphic 物件
                    return new Graphic({
                        // 4. 指定幾何
                        geometry: {
                            type: "polygon", 
                            rings: record.SHAPE.rings,
                            spatialReference: {
                                wkid: 102100
                            }
                        },
                        symbol: renderer,
                        // 5. 將紀錄中所有其他欄位都放進 attributes
                        attributes: record,
                        popupTemplate: popupTemplate
                    });
                });

                // 建立 GraphicsLayer
                const graphicsLayer = new GraphicsLayer({
                    id: "dynamicDataLayer",
                    graphics: graphics, // 將我們建立的所有 Graphic 物件放進來
                });

                // 11. 將圖層加入地圖
                map.add(graphicsLayer);

            })
            .catch(error => {
                console.error('錯誤:', error);
                alert("請求失敗，請查看 Console 的錯誤訊息。");
            });
        });

        // 13.  Expand 元件
        const expand = new Expand({
            view: view,
            content: controlsContainer, // 將我們的 controls div 放進去
            expandIcon: "layer-filter", // 設置圖示
            group: "top-right",
            expanded: true
        });
        view.ui.add(expand, "top-right");
    </script>
</head>
<body>
    <div id="viewDiv"></div>
    <div id="controls">
    <h4>分析設定</h4>
    
    <div>
        <label for="themeSelector">1. 選擇主題:</label>
        <select id="themeSelector">
            <option value="">-- 請選擇 --</option>
        </select>
    </div>

    <div style="margin-top: 5px;">
        <label for="subThemeSelector">2. 選擇指標:</label>
        <select id="subThemeSelector" disabled>
            <option value="">-- 請先選擇主題 --</option>
        </select>
    </div>

    <hr>

    <div style="margin-top: 5px;">
        <label for="layerSelector1">3. 圖層一:</label>
        <select id="layerSelector1" disabled>
            <option value="">-- 請先選擇指標 --</option>
        </select>
    </div>
    <div style="margin-top: 5px;">
        <label for="layerSelector2">4. 圖層二:</label>
        <select id="layerSelector2" disabled>
            <option value="">-- 請先選擇指標 --</option>
        </select>
    </div>
    
    <hr>
    <button id="runAnalysisBtn">執行兩時間差分析</button>
</div>
</div>
</body>
</html>